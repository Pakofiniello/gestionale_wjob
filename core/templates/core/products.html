{% extends "core/base.html" %}

{% block title %}Prodotti - Gestionale Magazzino{% endblock %}
{% block page_title %}Prodotti{% endblock %}

{% block content %}
<!-- Header con azioni -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <div>
        <p style="color: var(--text-secondary); margin-top: 8px;">Gestisci il catalogo prodotti del magazzino</p>
    </div>
    <button class="btn btn-primary" onclick="openAddProductModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Aggiungi Prodotto
    </button>
</div>

<!-- Filtri e Ricerca -->
<div class="table-container" style="margin-bottom: 24px;">
    <div style="padding: 20px; display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
        <div class="search-box" style="flex: 1; min-width: 250px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
            <input type="text" placeholder="Cerca prodotti..." id="productSearch">
        </div>
        
        <select class="form-select" style="width: 180px;" id="categoryFilter">
            <option value="">Tutte le categorie</option>
            {% for categoria in categories %}
            <option value="{{ categoria.id }}">{{ categoria.nome_categoria }}</option>
            {% endfor %}
        </select>
        
        <select class="form-select" style="width: 160px;" id="stockFilter">
            <option value="">Tutti i prodotti</option>
            <option value="in-stock">In magazzino</option>
            <option value="low-stock">Stock basso</option>
            <option value="out-of-stock">Esauriti</option>
        </select>
        
        <button class="btn btn-secondary btn-sm">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="21" y1="6" x2="3" y2="6"/>
                <line x1="15" y1="12" x2="3" y2="12"/>
                <line x1="17" y1="18" x2="3" y2="18"/>
            </svg>
            Filtri
        </button>
    </div>
</div>

<!-- Products Grid -->
<div class="products-grid" id="productsGrid">
    {% if prodotti %}
        {% for prodotto in prodotti %}
        <div class="product-card" data-category="{{ prodotto.categoria.id }}" data-stock="{{ prodotto.stock }}" data-product-id="{{ prodotto.id }}">
            <div class="product-image" style="background: linear-gradient(135deg, #7C9885, #A8C4B3);">
                {% if prodotto.image %}
                    <img src="{{ prodotto.image }}" alt="{{ prodotto.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="2" y="3" width="20" height="14" rx="2"/>
                        <line x1="8" y1="21" x2="16" y2="21"/>
                        <line x1="12" y1="17" x2="12" y2="21"/>
                    </svg>
                {% endif %}
            </div>
            <div class="product-body">
                <div class="product-category">{{ prodotto.categoria.nome_categoria }}</div>
                <h3 class="product-name">{{ prodotto.name }}</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">
                    SKU: {{ prodotto.codice_univoco }}
                </p>
                <div class="product-footer">
                    <div>
                        <div class="product-price">€{{ prodotto.prezzo }}</div>
                        <div class="product-stock">
                            Stock: {{ prodotto.stock }} unità
                            {% if prodotto.stock <= prodotto.ordine_riordino %}
                                <span style="color: var(--error);">⚠️</span>
                            {% endif %}
                        </div>
                    </div>
                    <button class="btn btn-sm btn-primary" data-product-id="{{ prodotto.id }}" onclick="viewProductDetails(this.dataset.productId)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 20px; opacity: 0.5;">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
            <h3 style="color: var(--text-secondary); margin-bottom: 8px;">Nessun prodotto trovato</h3>
            <p style="color: var(--text-secondary); font-size: 14px;">Aggiungi un nuovo prodotto per iniziare.</p>
        </div>
    {% endif %}
</div>

<!-- Modal Dettagli Prodotto -->
<div class="modal-overlay" id="productDetailsModal">
    <div class="modal" style="max-width: 900px;">
        <div class="modal-header">
            <h2 class="modal-title">Dettagli Prodotto</h2>
            <button class="modal-close" onclick="closeProductDetailsModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 32px;">
                <!-- Immagine Prodotto -->
                <div>
                    <div id="productDetailImage" style="width: 100%; height: 300px; background: linear-gradient(135deg, #7C9885, #A8C4B3); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px;">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5">
                            <rect x="2" y="3" width="20" height="14" rx="2"/>
                            <line x1="8" y1="21" x2="16" y2="21"/>
                            <line x1="12" y1="17" x2="12" y2="21"/>
                        </svg>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                        <div style="height: 60px; background: var(--bg-hover); border-radius: 8px;"></div>
                        <div style="height: 60px; background: var(--bg-hover); border-radius: 8px;"></div>
                        <div style="height: 60px; background: var(--bg-hover); border-radius: 8px;"></div>
                    </div>
                </div>
                
                <!-- Info Prodotto -->
                <div>
                    <div style="margin-bottom: 8px;">
                        <span class="badge badge-success" id="productDetailCategory">Elettronica</span>
                    </div>
                    <h2 id="productDetailName" style="font-size: 28px; font-weight: 700; margin-bottom: 12px;">Laptop Dell XPS 15</h2>
                    <div id="productDetailPrice" style="font-size: 32px; font-weight: 700; color: var(--primary-dark); margin-bottom: 24px;">€1,299.99</div>
                    
                    <!-- Info griglia -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px; padding: 20px; background: var(--bg-hover); border-radius: 12px;">
                        <div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">SKU</div>
                            <div id="productDetailSku" style="font-weight: 600;">DELL-XPS-001</div>
                        </div>
                        <div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Stock Disponibile</div>
                            <div id="productDetailStock" style="font-weight: 600; color: var(--success);">15 unità</div>
                        </div>
                        <div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Soglia Riordino</div>
                            <div id="productDetailReorder" style="font-weight: 600;">10 unità</div>
                        </div>
                        <div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Ubicazione</div>
                            <div id="productDetailLocation" style="font-weight: 600;">Scaffale A-12</div>
                        </div>
                    </div>
                    
                    <!-- Descrizione -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Descrizione</h3>
                        <p id="productDetailDescription" style="color: var(--text-secondary); line-height: 1.6;">
                            Laptop professionale ad alte prestazioni con display 15.6" 4K OLED, processore Intel Core i7 di ultima generazione, 16GB RAM DDR4, SSD 512GB NVMe. Ideale per professionisti e creativi.
                        </p>
                    </div>
                    
                    <!-- Statistiche -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="text-align: center; padding: 16px; background: var(--bg-hover); border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--primary-dark);">156</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Venduti (mese)</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--bg-hover); border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--success);">4.8</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Rating medio</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--bg-hover); border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--info);">23</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">In transito</div>
                        </div>
                    </div>
                    
                    <!-- Azioni -->
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" style="flex: 1;" onclick="editProduct()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            Modifica
                        </button>
                        <button class="btn btn-secondary" onclick="adjustProductStock()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                <polyline points="9 22 9 12 15 12 15 22"/>
                            </svg>
                            Rettifica Stock
                        </button>
                        <button class="btn btn-danger" onclick="deleteProduct()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tabs aggiuntivi -->
            <div style="margin-top: 32px; padding-top: 24px; border-top: var(--border);">
                <div style="display: flex; gap: 24px; border-bottom: var(--border); margin-bottom: 24px;">
                    <button class="tab-btn active" onclick="switchTab('history')" style="padding: 12px 0; border: none; background: none; color: var(--text-secondary); font-weight: 600; border-bottom: 2px solid transparent; cursor: pointer;" id="historyTab">Storico Movimenti</button>
                    <button class="tab-btn" onclick="switchTab('suppliers')" style="padding: 12px 0; border: none; background: none; color: var(--text-secondary); font-weight: 600; border-bottom: 2px solid transparent; cursor: pointer;" id="suppliersTab">Fornitori</button>
                </div>
                
                <!-- Tab Storico -->
                <div id="historyTabContent">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Quantità</th>
                                <th>Utente</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>07/01/2026 14:32</td>
                                <td><span class="badge badge-error">Uscita</span></td>
                                <td>-3</td>
                                <td>Mario Rossi</td>
                                <td>Ordine #ORD-2026-087</td>
                            </tr>
                            <tr>
                                <td>05/01/2026 11:20</td>
                                <td><span class="badge badge-success">Entrata</span></td>
                                <td>+20</td>
                                <td>Laura Bianchi</td>
                                <td>Rifornimento fornitore</td>
                            </tr>
                            <tr>
                                <td>03/01/2026 09:15</td>
                                <td><span class="badge badge-error">Uscita</span></td>
                                <td>-5</td>
                                <td>Giuseppe Verdi</td>
                                <td>Ordine #ORD-2026-075</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Tab Fornitori -->
                <div id="suppliersTabContent" style="display: none;">
                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--bg-hover); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">TechItalia SpA</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Fornitore principale • Prezzo: €1,150.00</div>
                            </div>
                            <button class="btn btn-sm btn-primary">Riordina</button>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--bg-hover); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">ElectroDistrib Srl</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Fornitore alternativo • Prezzo: €1,180.00</div>
                            </div>
                            <button class="btn btn-sm btn-secondary">Contatta</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Aggiungi Prodotto -->
<div class="modal-overlay" id="addProductModal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Aggiungi Nuovo Prodotto</h2>
            <button class="modal-close" onclick="closeAddProductModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <form id="addProductForm" method="POST" action="{% url 'core:product_save' %}">
        <div class="modal-body">
                {% csrf_token %}
                <div class="form-group">
                    <label class="form-label">Nome Prodotto</label>
                    <input type="text" class="form-input" name="name" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">SKU</label>
                    <input type="text" class="form-input" name="codice_univoco" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <select class="form-select" name="categoria" required>
                            <option value="">Seleziona...</option>
                            {% for categoria in categories %}
                            <option value="{{ categoria.id }}">{{ categoria.nome_categoria }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fornitore</label>
                        <select class="form-select" name="fornitore">
                            <option value="">Seleziona...</option>
                            {% for fornitore in fornitori %}
                            <option value="{{ fornitore.id }}">{{ fornitore.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Prezzo Vendita (€)</label>
                        <input type="number" class="form-input" name="prezzo" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Prezzo di Base (€)</label>
                        <input type="number" class="form-input" name="prezzo_di_base" step="0.01">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Quantità Stock</label>
                        <input type="number" class="form-input" name="stock" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Soglia Riordino</label>
                        <input type="number" class="form-input" name="ordine_riordino" value="10">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Unità in Transito</label>
                        <input type="number" class="form-input" name="unita_in_transito" value="0">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Ubicazione</label>
                        <input type="text" class="form-input" name="location" placeholder="es. Scaffale A-12">
                    </div>
                    
                    <div class="form-group" style="display: flex; align-items: center; padding-top: 28px;">
                        <label class="form-label" style="display: flex; align-items: center; margin-bottom: 0;">
                            <input type="checkbox" name="is_active" checked style="margin-right: 8px;">
                            <span>Prodotto Attivo</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">URL Immagine</label>
                    <input type="text" class="form-input" name="image" placeholder="https://...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descrizione (opzionale)</label>
                    <textarea class="form-textarea" name="descrizione" rows="3" placeholder="Descrizione del prodotto..."></textarea>
                </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeAddProductModal()">Annulla</button>
            <button type="submit" class="btn btn-primary">Salva Prodotto</button>
        </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Dati prodotti caricati dal backend
const productsData = {};

// Popola i dati dei prodotti dal template
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.product-card').forEach(card => {
        const productId = card.dataset.productId;
        const name = card.querySelector('.product-name').textContent;
        const category = card.querySelector('.product-category').textContent;
        const price = parseFloat(card.querySelector('.product-price').textContent.replace('€', ''));
        const sku = card.querySelector('p').textContent.replace('SKU: ', '');
        const stock = parseInt(card.dataset.stock);
        const description = card.querySelector('.product-name').textContent;
        
        productsData[productId] = {
            name: name,
            category: category,
            price: price,
            stock: stock,
            sku: sku,
            reorder: 10,
            location: 'Scaffale A-01',
            description: description,
            gradient: card.querySelector('.product-image').style.background
        };
    });
});

function openAddProductModal() {
    document.getElementById('addProductModal').classList.add('active');
}

function closeAddProductModal() {
    document.getElementById('addProductModal').classList.remove('active');
}

function saveProduct() {
    const form = document.getElementById('addProductForm');
    if (form.checkValidity()) {
        const formData = new FormData(form);
        // Qui puoi inviare i dati al server con AJAX
        alert('Prodotto salvato!');
        closeAddProductModal();
        form.reset();
    }
}

let currentProductId = null;

function viewProductDetails(id) {
    currentProductId = id;
    const product = productsData[id];
    
    if (!product) {
        alert('Prodotto non trovato');
        return;
    }
    
    // Popola i dati nel modal
    document.getElementById('productDetailName').textContent = product.name;
    document.getElementById('productDetailCategory').textContent = product.category;
    document.getElementById('productDetailPrice').textContent = '€' + product.price.toFixed(2);
    document.getElementById('productDetailSku').textContent = product.sku;
    document.getElementById('productDetailStock').textContent = product.stock + ' unità';
    document.getElementById('productDetailReorder').textContent = product.reorder + ' unità';
    document.getElementById('productDetailLocation').textContent = product.location;
    document.getElementById('productDetailDescription').textContent = product.description;
    
    // Cambia il gradiente dell'immagine
    if (product.gradient) {
        document.getElementById('productDetailImage').style.background = product.gradient;
    }
    
    // Colore stock
    const stockEl = document.getElementById('productDetailStock');
    if (product.stock <= product.reorder) {
        stockEl.style.color = 'var(--error)';
    } else {
        stockEl.style.color = 'var(--success)';
    }
    
    // Apri il modal
    document.getElementById('productDetailsModal').classList.add('active');
}

function closeProductDetailsModal() {
    document.getElementById('productDetailsModal').classList.remove('active');
    currentProductId = null;
}

function switchTab(tab) {
    // Rimuovi active da tutti i tab
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.style.borderBottomColor = 'transparent';
        btn.style.color = 'var(--text-secondary)';
    });
    
    // Nascondi tutti i contenuti
    document.getElementById('historyTabContent').style.display = 'none';
    document.getElementById('suppliersTabContent').style.display = 'none';
    
    // Attiva il tab selezionato
    if (tab === 'history') {
        document.getElementById('historyTab').style.borderBottomColor = 'var(--primary)';
        document.getElementById('historyTab').style.color = 'var(--primary)';
        document.getElementById('historyTabContent').style.display = 'block';
    } else if (tab === 'suppliers') {
        document.getElementById('suppliersTab').style.borderBottomColor = 'var(--primary)';
        document.getElementById('suppliersTab').style.color = 'var(--primary)';
        document.getElementById('suppliersTabContent').style.display = 'block';
    }
}

function editProduct() {
    alert('Apertura editor prodotto...');
}

function adjustProductStock() {
    alert('Apertura form rettifica stock...');
    closeProductDetailsModal();
}

function deleteProduct() {
    if (confirm('Sei sicuro di voler eliminare questo prodotto?')) {
        alert('Prodotto eliminato');
        closeProductDetailsModal();
    }
}

// Filtri
document.getElementById('productSearch')?.addEventListener('input', function(e) {
    filterProducts();
});

document.getElementById('categoryFilter')?.addEventListener('change', function(e) {
    filterProducts();
});

document.getElementById('stockFilter')?.addEventListener('change', function(e) {
    filterProducts();
});

function filterProducts() {
    const searchTerm = document.getElementById('productSearch').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;
    const stockFilter = document.getElementById('stockFilter').value;
    
    const products = document.querySelectorAll('.product-card');
    
    products.forEach(product => {
        const name = product.querySelector('.product-name').textContent.toLowerCase();
        const productCategory = product.dataset.category;
        const stock = parseInt(product.dataset.stock);
        
        let show = true;
        
        if (searchTerm && !name.includes(searchTerm)) {
            show = false;
        }
        
        if (category && productCategory !== category) {
            show = false;
        }
        
        if (stockFilter === 'low-stock' && stock >= 10) {
            show = false;
        } else if (stockFilter === 'out-of-stock' && stock > 0) {
            show = false;
        } else if (stockFilter === 'in-stock' && stock === 0) {
            show = false;
        }
        
        product.style.display = show ? 'block' : 'none';
    });
}
</script>
{% endblock %}